---
title: "P8157 HW 4"
author: "Sabrina Lin stl2137"
date: "11/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.table)
library(gee)
library(geepack)
library(lme4)
library(doBy)
library(tidyr)
library(mice)
library(purrr)
library(mitml)
library(CRTgeeDR)
```

# Question 1

```{r}
### Import Data

toenail_dat <- read.delim("/Users/SabrinaLin/Documents/Fall_2020_Longitudinal/HW2/toenail.txt", header = TRUE, sep = "", col.names = c("ID", "Y", "Treatment", "Month", "Visit")) %>% 
  janitor::clean_names() %>% 
  mutate(
    treatment = as.factor(treatment), 
    visit = as.factor(visit)
  )

#making into data.table

toenail_tab_dat <- data.table(toenail_dat)
```

## Part 1 
Consider a first order transition model for the log odds of moderate or severe onycholysis. Set up a suitable model assuming linear trends. Use month as the time variable.

```{r}
### add response at lag 1
toenail_tab_dat[, y_1 := shift(y, n = 1, type = "lag", fill = NA), by = "id"]

### transition probabilities
tab1 <- table(toenail_tab_dat$y, toenail_tab_dat$y_1)
round(prop.table(tab1,margin = 1),2)

### model w/ interaction term

toenail_mod_lag_1 <- gee(y ~ treatment*month + treatment*y_1, corstr = "independence", family = binomial("logit"), id = id, data = toenail_tab_dat)
round(summary(toenail_mod_lag_1)$coeff,2)
```

* Since the interaction term between treatment and month is insignificant with a naive z-score of -0.91 and a robust z-score of -0.81, it will be taken out of the model. 

* Since the interaction term between treatment and lag 1 (represented by `y_1`) is insignificant with a naive z-score of 1.33 and a robust z-score of 1.40, it will be taken out of the model. 

```{r}
### Model w/o interaction term

toenail_mod_lag_1b <- gee(y ~ treatment + month + y_1, corstr = "independence", family = binomial("logit"), id = id, data = toenail_tab_dat)
round(summary(toenail_mod_lag_1b)$coeff, 2)
```

## Part 2
Repeat the model using a second order transition model. Is there a justification for a second order transition model?

# Do we need both lag 1 and lag 2?

```{r}
### add response at lag 2 
toenail_tab_dat[, y_2 := shift(y, n = 2, type = "lag", fill = NA), by = "id"]

### transition probabilities
tab2 <- table(toenail_tab_dat$y, toenail_tab_dat$y_2)
round(prop.table(tab2, margin = 1), 2)

### model w/ interaction term

toenail_mod_lag_2 <- gee(y ~ treatment + month + treatment*y_2 + treatment*y_1, corstr = "independence", family = binomial("logit"), id = id, data = toenail_tab_dat)
round(summary(toenail_mod_lag_2)$coeff,2)


```

## Part 3
Provide Interpretations for the parameters in your model.

## Part 4
How are the interpretations different from the models in HW2 and HW3.

# Question 2

```{r}
### importing given code

toenail <- fread("/Users/SabrinaLin/Documents/Fall_2020_Longitudinal/HW2/toenail.txt")
colnames(toenail) <- c("id","response","treatment","month","visit")
toenail2 <- tidyr::complete(toenail, id, visit) %>%
              tidyr::fill(treatment) %>% 
  mutate(
    visit = as.factor(visit)
  )
toenail2 <- as.data.table(toenail2)
```

## Part 1
Perform a complete case analysis considering a GEE model for the log odds of moderate or severe onycholysis. Set up a suitable model assuming linear trends. Use visit as the time variable.

```{r}
# complete case analysis 
count <- toenail2[,j = list(n=sum(!is.na(response))), by = "id"]
table(count$n)
count <- count[n==7]
toenail_1 <- toenail2[id %in% count$id]
table(toenail_1$response,useNA = "always")
table(toenail_1$visit,toenail_1$response, useNA = "always")
gee1 <- geeglm(response ~ treatment + visit, id = id, data = toenail_1, family = binomial(link = "logit"), corstr = "unstructured")
summary(gee1)
```

## Part 2
Perform an available case analysis considering a GEE model for the log odds of moderate or severe onycholysis. Set up a suitable model assuming linear trends. Use visit as the time variable.

```{r}
toenail_2 <- toenail2
table(toenail_2$response, useNA = "always")
table(toenail_2$visit, toenail_2$response, useNA = "always")
gee2 <- geeglm(response ~ treatment + visit, id = id, data = toenail_2, family = binomial(link = "logit"), corstr = "unstructured")
summary(gee2)
```

## Part 3
Perform an LOCF analysis considering a GEE model for the log odds of moderate or severe onycholysis. Set up a suitable model assuming linear trends. Use visit as the time variable.

```{r}
toenail_3 <- lapply(unique(toenail2$id), function(z){tidyr::fill(toenail2[id == z], response)})
toenail_3 <- rbindlist((toenail_3))
table(toenail_3$visit, toenail_3$response, useNA = "always")

gee3 <- geeglm(response ~ treatment + visit, id = id, data = toenail_3, family = binomial(link = "logit"), corstr = "unstructured")
summary(gee3)
```

## Part 4

Perform an multiple imputation based analysis considering a GEE model for the log odds of moderate or severe onycholysis. Set up a suitable model assuming linear trends. Use visit as the time variable.

# imputation not working

```{r}
# MI
toenail_4 <- toenail2
pred <- make.predictorMatrix(toenail_4)
pred
pred["response", "id"] <- -2
pred
pred <- pred["response",,drop = FALSE]
pred
toenail_4$id <- as.integer(toenail_4$id)
imp <- mice(toenail_4, method = "2l.bin", pred = pred, seed = 1234, maxit = 1, m = 5, print = FALSE, blocks = list(c("response")))
table(mice::complete(imp)$response, useNA = "always")
```

```{r}
### GEE
implist <- mids2mitml.list(imp)
gee4 <- with(implist, geeglm(status ~ gender + (current_age + I(current_age^2)), id=id,family = binomial, corstr = "unstructured"))
testEstimates(gee4)

implist <- mids2mitml.list(imp)
gee4 <- with(implist, geeglm(response ~ treatment + month, id=id,family = binomial, corstr = "unstructured"))
testEstimates(gee4)
```

## Part 5

```{r}
lme1 <- mice::complete(imp, "all") %>% 
  purrr::map(lme4::glmer,
             formula = response ~ treatment + month + (1 | id),
             family = binomial) %>% 
  pool() %>% 
  summary()
```

